# .zshrc

# Set up completions
fpath=(~/.config/zsh/completion $fpath)
autoload compinit
compinit

# Use bash completions
autoload bashcompinit
bashcompinit

# Fix keys and shortcuts
WORDCHARS='_'
bindkey "^[[3~" delete-char
bindkey "^[[1;5C" forward-word
bindkey "^[[1;5D" backward-word
bindkey "^A" vi-beginning-of-line
bindkey "^E" vi-end-of-line
bindkey "^H" backward-kill-word
bindkey "^[[3;5~" kill-word

# Set up distrobox completions
source /usr/share/bash-completion/completions/distrobox
source /usr/share/bash-completion/completions/distrobox-assemble
source /usr/share/bash-completion/completions/distrobox-create
source /usr/share/bash-completion/completions/distrobox-enter
source /usr/share/bash-completion/completions/distrobox-ephemeral
source /usr/share/bash-completion/completions/distrobox-generate-entry
source /usr/share/bash-completion/completions/distrobox-list
source /usr/share/bash-completion/completions/distrobox-rm
source /usr/share/bash-completion/completions/distrobox-stop
source /usr/share/bash-completion/completions/distrobox-upgrade

# Integrate neovim
if command -v nvim &> /dev/null; then
  alias vim=nvim
fi

# Integrate marktext
function marktext {
  flatpak run com.github.marktext.marktext "$@"
}
compdef _files marktext

# Integrate wezterm
function wezterm {
  flatpak run org.wezfurlong.wezterm "$@"
}

# Integrate aqua
if command -v aqua &> /dev/null; then
  aqua i -a
  source <(aqua completion zsh)
fi

# Integrate tere
if command -v tere &> /dev/null; then
  tere() {
    local result=$($HOME/.local/share/aquaproj-aqua/bin/tere --mouse=on "$@")
    [ -n "$result" ] && cd -- "$result"
  }
fi

# Integrate lf
if command -v lf &> /dev/null; then
  function lfcd {
    cd "$($HOME/.local/share/aquaproj-aqua/bin/lf -print-last-dir "$@")"
  }
fi

# Integrate cheat
if command -v fzf &> /dev/null; then
  export CHEAT_USE_FZF=true
fi

# Integrate ripgrep-all
if command -v rga &> /dev/null && command -v fzf &> /dev/null; then
  rga-fzf() {
    RG_PREFIX="rga --files-with-matches"
    local file
    file="$(
      FZF_DEFAULT_COMMAND="$RG_PREFIX '$1'" \
        fzf --sort --preview="[[ ! -z {} ]] && rga --pretty --context 5 {q} {}" \
          --phony -q "$1" \
          --bind "change:reload:$RG_PREFIX {q}" \
          --preview-window="70%:wrap"
    )" &&
    echo "opening $file" &&
    xdg-open "$file"
  }
fi

# Enable starship
if command -v starship &> /dev/null; then
  eval "$(starship init zsh)"
fi

# Enable direnv
if command -v direnv &> /dev/null; then
  eval "$(direnv hook zsh)"
fi

# Enable atuin
if command -v atuin &> /dev/null; then
  eval "$(atuin init zsh)"
fi

# Integrate zoxide
eval "$(zoxide init zsh)"
# TODO: include https://github.com/marlonrichert/zsh-autocomplete

if command -v zellij &> /dev/null && [ ! -z "${ZELLIJ}" ]; then
  zellij action rename-tab ''
fi
